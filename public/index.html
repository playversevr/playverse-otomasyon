<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>vr-kafe-panel | CanlÄ± Takip</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0b0b0b; color: #e0e0e0; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 320px; background: #151515; padding: 20px; border-right: 2px solid #222; overflow-y: auto; }
        #main { flex: 1; padding: 25px; background: #0b0b0b; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; }
        .card { background: #1c1c1c; padding: 20px; border-radius: 15px; border: 2px solid #333; text-align: center; position: relative; transition: 0.3s; }
        .card.sure-doldu { border-color: #ff3e3e; box-shadow: 0 0 20px rgba(255, 62, 62, 0.2); }
        .timer { font-size: 42px; font-weight: bold; color: #00fbff; margin: 15px 0; font-family: 'Courier New', monospace; }
        .btn { cursor: pointer; border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; margin-top: 8px; color: white; transition: 0.2s; }
        .btn:active { transform: scale(0.98); }
        .btn-vr { background: #2563eb; } .btn-vr:hover { background: #1d4ed8; }
        .btn-pay { background: #8e44ad; margin-top: 15px; border: 1px solid #a855f7; }
        .btn-pay:hover { background: #7b39a1; }
        input, select { background: #252525; color: white; border: 1px solid #444; padding: 12px; width: 100%; margin: 8px 0; border-radius: 8px; box-sizing: border-box; }
        h3 { border-bottom: 1px solid #333; padding-bottom: 10px; color: #00fbff; }
        .ozet-text { font-size: 14px; color: #aaa; margin-bottom: 10px; }
    </style>
</head>
<body>

<div id="sidebar">
    <h3>âš™ï¸ Ayarlar</h3>
    <label>30 Dakika FiyatÄ± (â‚º)</label>
    <input type="number" id="f-30" value="250">
    <label>60 Dakika FiyatÄ± (â‚º)</label>
    <input type="number" id="f-60" value="450">
    
    <h3 style="margin-top: 30px;">â˜• Kantin</h3>
    <label>Masa SeÃ§</label>
    <select id="hedef-masa">
        <option value="1">Masa 1</option><option value="2">Masa 2</option>
        <option value="3">Masa 3</option><option value="4">Masa 4</option>
        <option value="5">Masa 5</option><option value="6">Masa 6</option>
    </select>
    <button class="btn" style="background:#d97706" onclick="urunEkle()">â• Ä°Ã§ecek Ekle (20â‚º)</button>
    
    <div style="margin-top: 50px; font-size: 12px; color: #444;">Bulut BaÄŸlantÄ±sÄ±: Aktif âœ…</div>
</div>

<div id="main">
    <h1 style="margin: 0 0 25px 0; display: flex; align-items: center; gap: 10px;">
        <span style="color: #00fbff;">ğŸ® vr-kafe-panel</span>
    </h1>
    <div class="grid" id="cihazlar"></div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.1.3/firebase-database-compat.js"></script>

<script>
    // Firebase YapÄ±landÄ±rman
    const firebaseConfig = {
        apiKey: "AIzaSyCGk6ca-X8wCbLB7xOu5imiH6g23ZmazyQ",
        authDomain: "vr-kafe-panel.firebaseapp.com",
        databaseURL: "https://vr-kafe-panel-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "vr-kafe-panel",
        storageBucket: "vr-kafe-panel.firebasestorage.app",
        messagingSenderId: "464538264349",
        appId: "1:464538264349:web:09bf50fd4ac50e1372b7f4"
    };

    // Firebase BaÅŸlat
    firebase.initializeApp(firebaseConfig);
    const rtdb = firebase.database();

    let cihazVerileri = {};

    // ArayÃ¼zÃ¼ OluÅŸtur
    function cihazlariOlustur() {
        const grid = document.getElementById('cihazlar');
        grid.innerHTML = ''; 
        for(let i=1; i<=6; i++) {
            if(!cihazVerileri[i]) cihazVerileri[i] = { bitis_ms: 0, toplam: 0 };
            
            grid.innerHTML += `
                <div class="card" id="card-${i}">
                    <h2 style="margin:0;">Ä°stasyon #${i}</h2>
                    <div class="timer" id="time-${i}">00:00</div>
                    <div class="ozet-text" id="ozet-${i}">Mevcut BorÃ§: <b>${cihazVerileri[i].toplam}â‚º</b></div>
                    <button class="btn btn-vr" onclick="vrEkle(${i},30)">+30 Dakika</button>
                    <button class="btn btn-vr" onclick="vrEkle(${i},60)">+60 Dakika</button>
                    <button class="btn btn-pay" onclick="masaKapat(${i})">MASAYI SIFIRLA</button>
                </div>`;
        }
    }

    // SÃ¼re Ekle
    function vrEkle(id, dk) {
        let fiyat = dk === 30 ? parseInt(document.getElementById('f-30').value) : parseInt(document.getElementById('f-60').value);
        let simdi = new Date().getTime();
        let temelSÃ¼re = (cihazVerileri[id].bitis_ms > simdi) ? cihazVerileri[id].bitis_ms : simdi;
        
        cihazVerileri[id].bitis_ms = temelSÃ¼re + (dk * 60 * 1000);
        cihazVerileri[id].toplam += fiyat;
        
        firebaseGuncelle(id);
    }

    // ÃœrÃ¼n Ekle
    function urunEkle() {
        let id = document.getElementById('hedef-masa').value;
        cihazVerileri[id].toplam += 20; // Standart iÃ§ecek fiyatÄ±
        firebaseGuncelle(id);
    }

    // Firebase'e GÃ¶nder
    function firebaseGuncelle(id) {
        rtdb.ref('aktif_masalar/' + id).set({
            bitis_ms: cihazVerileri[id].bitis_ms,
            toplam: cihazVerileri[id].toplam
        });
    }

    // MasayÄ± Kapat/SÄ±fÄ±rla
    async function masaKapat(id) {
        if(!confirm(`Masa #${id} sÄ±fÄ±rlanacak. Emin misiniz?`)) return;
        await rtdb.ref('aktif_masalar/' + id).remove();
        cihazVerileri[id] = { bitis_ms: 0, toplam: 0 };
        cihazlariOlustur();
    }

    // SayaÃ§ MantÄ±ÄŸÄ±
    function sayacYonetimi() {
        for(let i=1; i<=6; i++) {
            if(!cihazVerileri[i] || cihazVerileri[i].bitis_ms === 0) {
                document.getElementById(`time-${i}`).innerText = "00:00";
                continue;
            }
            
            let simdi = new Date().getTime();
            let fark = cihazVerileri[i].bitis_ms - simdi;
            let kalan_saniye = Math.floor(fark / 1000);
            
            const tEl = document.getElementById(`time-${i}`);
            const cEl = document.getElementById(`card-${i}`);
            
            let mutlak = Math.abs(kalan_saniye);
            let dak = Math.floor(mutlak / 60);
            let san = mutlak % 60;
            
            tEl.innerText = (kalan_saniye < 0 ? "-" : "") + `${dak}:${san < 10 ? '0'+san : san}`;
            
            if(kalan_saniye < 0) cEl.classList.add('sure-doldu');
            else cEl.classList.remove('sure-doldu');
        }
    }

    // Firebase'den Verileri Dinle (CanlÄ± GÃ¼ncelleme)
    rtdb.ref('aktif_masalar').on('value', (snapshot) => {
        const data = snapshot.val();
        // Verileri temizle ve gÃ¼ncelle
        for(let i=1; i<=6; i++) {
            if(data && data[i]) {
                cihazVerileri[i] = { 
                    bitis_ms: data[i].bitis_ms, 
                    toplam: data[i].toplam || 0 
                };
            } else {
                cihazVerileri[i] = { bitis_ms: 0, toplam: 0 };
            }
        }
        cihazlariOlustur();
    });

    setInterval(sayacYonetimi, 1000);
</script>
</body>
</html>
