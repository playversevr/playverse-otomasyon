<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <title>PLAYVERSE VR MERKEZƒ∞ KONTROL Sƒ∞STEMƒ∞</title>
    <style>
        body { font-family: 'Segoe UI', sans-serif; background: #0b0b0b; color: #e0e0e0; margin: 0; display: flex; height: 100vh; overflow: hidden; }
        #sidebar { width: 350px; background: #151515; padding: 20px; border-right: 2px solid #222; overflow-y: auto; box-sizing: border-box; }
        #main { flex: 1; padding: 25px; background: #0b0b0b; overflow-y: auto; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; }
        .card { background: #1c1c1c; padding: 20px; border-radius: 15px; border: 2px solid #333; text-align: center; position: relative; }
        .card.sure-doldu { border-color: #ff3e3e; box-shadow: 0 0 20px rgba(255, 62, 62, 0.2); }
        .status-badge { position: absolute; top: 10px; right: 10px; font-size: 10px; padding: 4px 8px; border-radius: 4px; font-weight: bold; }
        .paid { background: #059669; color: white; }
        .unpaid { background: #d97706; color: white; }
        .timer { font-size: 38px; font-weight: bold; color: #00fbff; margin: 10px 0; font-family: monospace; }
        .btn { cursor: pointer; border: none; padding: 10px; border-radius: 6px; font-weight: bold; width: 100%; margin-top: 5px; transition: 0.2s; color: white; }
        .btn-vr { background: #2563eb; }
        .btn-icecek { background: #d97706; }
        .btn-pay { background: #8e44ad; font-size: 16px; border: 2px solid #a855f7; margin-top:10px; }
        .btn-kapat { background: #444; margin-top: 10px; }
        .btn-sil { background: #991b1b; color: white; border: none; border-radius: 4px; cursor: pointer; width: 22px; height: 22px; font-weight: bold; }
        input, select { background: #252525; color: white; border: 1px solid #444; padding: 10px; width: 100%; margin: 5px 0; border-radius: 6px; box-sizing: border-box; }
        .masa-ozet { font-size: 12px; color: #888; margin: 10px 0; border-top: 1px solid #333; padding-top: 10px; text-align: left; }
        .urun-satir { display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px; background: #252525; padding: 4px 10px; border-radius: 4px; }
        .rapor-ozet-box { background: #1e3a8a33; padding: 15px; border-radius: 10px; margin-top: 10px; border: 1px solid #1e3a8a; }
        .accordion-header { background:#222; padding:10px; cursor:pointer; display:flex; justify-content:space-between; font-weight:bold; border-bottom:1px solid #333; margin-top:5px; border-radius:5px; }
        .accordion-content { display:none; background:#111; padding:10px; font-size:11px; border-radius: 0 0 5px 5px; border: 1px solid #333; border-top: none; }
    </style>
</head>
<body>
<div id="sidebar">
    <div style="background: #1e3a8a; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
        <h3 style="margin:0; font-size: 16px;">‚öôÔ∏è Fiyat Ayarlarƒ±</h3>
        <div style="display:flex; gap:5px;">
            <div><label style="font-size:10px">VR 30(‚Ç∫)</label><input type="number" id="f-30" value="250"></div>
            <div><label style="font-size:10px">VR 60(‚Ç∫)</label><input type="number" id="f-60" value="450"></div>
        </div>
        <div style="display:flex; gap:5px;">
            <div><label style="font-size:10px">√áay(‚Ç∫)</label><input type="number" id="f-cay" value="15"></div>
            <div><label style="font-size:10px">Kahve(‚Ç∫)</label><input type="number" id="f-kahve" value="40"></div>
        </div>
        <button class="btn" style="background:#4f46e5" onclick="fiyatGuncelle()">Fiyatlarƒ± Uygula</button>
    </div>

    <h3>‚òï Servis & Kantin</h3>
    <select id="kantin-urun-tip">
        <option value="√áay">üçµ √áay</option>
        <option value="Kahve">‚òï Kahve</option>
    </select>
    <select id="hedef-masa">
        <option value="MISAFIR">üë§ Misafir (Pe≈üin)</option>
        <option value="1">Masa 1</option><option value="2">Masa 2</option>
        <option value="3">Masa 3</option><option value="4">Masa 4</option>
        <option value="5">Masa 5</option><option value="6">Masa 6</option>
    </select>
    <button class="btn btn-icecek" onclick="urunEkle()">‚ûï ƒ∞√ßecek Ekle</button>

    <hr style="border:0; border-top:1px solid #333; margin:20px 0;">

    <h3>üìä Raporlama</h3>
    <input type="date" id="rep-bas">
    <input type="date" id="rep-bit">
    <button class="btn" style="background:#2563eb" onclick="raporAl()">Raporu Getir</button>
    <div id="rapor-sonuc"></div>
</div>

<div id="main">
    <h1 style="margin:0 0 20px 0; color: #00fbff;">üéÆ ƒ∞stasyon Y√∂netimi</h1>
    <div class="grid" id="cihazlar"></div>
</div>

<script>
    let F = { vr30: 250, vr60: 450, cay: 15, kahve: 40 };
    let cihazVerileri = {};

    function fiyatGuncelle() {
        F.vr30 = parseFloat(document.getElementById('f-30').value);
        F.vr60 = parseFloat(document.getElementById('f-60').value);
        F.cay = parseFloat(document.getElementById('f-cay').value);
        F.kahve = parseFloat(document.getElementById('f-kahve').value);
        cihazlariOlustur();
    }

    function cihazlariOlustur() {
        const grid = document.getElementById('cihazlar');
        grid.innerHTML = ''; 
        for(let i=1; i<=6; i++) {
            if(!cihazVerileri[i]) cihazVerileri[i] = { kalan: 0, interval: null, urunler: [], toplam: 0, odemeAlindi: false };
            let statusHtml = (cihazVerileri[i].toplam > 0) ? `<span class="status-badge ${cihazVerileri[i].odemeAlindi ? 'paid' : 'unpaid'}">${cihazVerileri[i].odemeAlindi ? '√ñDEME ALINDI' : '√ñDEME BEKLENƒ∞YOR'}</span>` : '';
            grid.innerHTML += `
                <div class="card" id="card-${i}">
                    ${statusHtml}
                    <h2>Masa #${i}</h2>
                    <div class="timer" id="time-${i}">00:00</div>
                    <div class="masa-ozet" id="ozet-${i}"></div>
                    <button class="btn btn-vr" onclick="vrEkle(${i},30,F.vr30)">+30 Dk</button>
                    <button class="btn btn-vr" onclick="vrEkle(${i},60,F.vr60)">+60 Dk</button>
                    <button class="btn btn-pay" onclick="odemeAl(${i})">√ñDEME AL / KAPAT</button>
                    <button class="btn btn-kapat" onclick="masaKapat(${i})">Sƒ±fƒ±rla</button>
                </div>`;
            guncelOzet(i);
        }
    }

    function urunEkle() {
        const h = document.getElementById('hedef-masa').value;
        const uTip = document.getElementById('kantin-urun-tip').value;
        const fiyat = uTip === '√áay' ? F.cay : F.kahve;
        if(h === "MISAFIR") {
            const y = confirm(`${uTip} satƒ±≈üƒ±. Nakit mi?`) ? 'NAKIT' : 'KREDI_KARTI';
            dbKaydet('KANTIN', `Misafir: ${uTip}`, fiyat, y);
            alert("Satƒ±≈ü kaydedildi.");
        } else {
            cihazVerileri[h].urunler.push({ ad: uTip, fiyat: fiyat });
            cihazVerileri[h].toplam += fiyat;
            cihazVerileri[h].odemeAlindi = false;
            cihazlariOlustur();
        }
    }

    function urunSil(id, idx) {
        cihazVerileri[id].toplam -= cihazVerileri[id].urunler[idx].fiyat;
        cihazVerileri[id].urunler.splice(idx, 1);
        cihazlariOlustur();
    }

    function vrEkle(id, dk, u) {
        cihazVerileri[id].kalan += dk * 60;
        cihazVerileri[id].urunler.push({ ad: `${dk}dk VR`, fiyat: u });
        cihazVerileri[id].toplam += u;
        cihazVerileri[id].odemeAlindi = false;
        if(!cihazVerileri[id].interval) cihazVerileri[id].interval = setInterval(()=>sayac(id), 1000);
        cihazlariOlustur();
    }

    function guncelOzet(id) {
        const o = document.getElementById(`ozet-${id}`);
        if(!o) return;
        let html = `Bor√ß: <b>${cihazVerileri[id].toplam}‚Ç∫</b><div style="margin-top:5px">`;
        cihazVerileri[id].urunler.forEach((u, i) => {
            html += `<div class="urun-satir"><span>${u.ad}</span><button class="btn-sil" onclick="urunSil(${id}, ${i})">‚àí</button></div>`;
        });
        o.innerHTML = html + "</div>";
    }

    async function odemeAl(id) {
        if(cihazVerileri[id].toplam <= 0) return alert("Bor√ß yok.");
        let t = prompt(`Masa #${id} Tahsilat:`, cihazVerileri[id].toplam);
        if(t === null) return;
        const y = confirm("Nakit mi?") ? 'NAKIT' : 'KREDI_KARTI';
        
        // Detaylarƒ± birle≈ütiriyoruz (√ñrn: "Masa #1 Tahsilat (2 √áay, 1 60dk VR)")
        const urunOzet = cihazVerileri[id].urunler.reduce((acc, curr) => {
            acc[curr.ad] = (acc[curr.ad] || 0) + 1;
            return acc;
        }, {});
        const detayMetni = Object.entries(urunOzet).map(([ad, count]) => `${count}x ${ad}`).join(", ");
        
        await dbKaydet('√ñDEME', `Masa #${id} Tahsilat (${detayMetni})`, parseFloat(t), y);
        cihazVerileri[id].odemeAlindi = true;
        cihazlariOlustur();
        raporAl();
    }

    async function dbKaydet(tur, urun, tutar, yontem) {
        await fetch('/api/islem-ekle', { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify({tur, urun_adi:urun, tutar, odeme_yontemi:yontem})});
    }

    async function raporAl() {
        const b = document.getElementById('rep-bas').value;
        const bit = document.getElementById('rep-bit').value;
        if(!b || !bit) return;
        const res = await fetch(`/api/rapor?baslangic=${b}&bitis=${bit}`);
        const data = await res.json();
        let n=0, k=0, html = '';
        data.forEach(v => {
            if(v.odeme_yontemi==='NAKIT') n+=v.tutar; else k+=v.tutar;
            
            // √úr√ºn adƒ±ndaki detaylarƒ± ayƒ±klƒ±yoruz
            const anaBaslik = v.urun_adi.split(" (")[0];
            const detaylar = v.urun_adi.includes("(") ? v.urun_adi.split("(")[1].replace(")", "") : "Detay yok";

            html += `
                <div style="margin-top:5px;">
                    <div class="accordion-header" onclick="this.nextElementSibling.style.display = this.nextElementSibling.style.display === 'none' ? 'block' : 'none'">
                        <span>${v.saat} | ${anaBaslik}</span>
                        <span style="color:#fbbf24">${v.tutar}‚Ç∫ ‚ñæ</span>
                    </div>
                    <div class="accordion-content">
                        <b>Adisyon ƒ∞√ßeriƒüi:</b><br>${detaylar}<br><br>
                        <b>√ñdeme T√ºr√º:</b> ${v.odeme_yontemi}
                    </div>
                </div>`;
        });
        document.getElementById('rapor-sonuc').innerHTML = `<div class="rapor-ozet-box">Nakit: ${n}‚Ç∫ | Kart: ${k}‚Ç∫<hr>Toplam: ${n+k}‚Ç∫</div>` + html;
    }

    function sayac(id) {
        let c = cihazVerileri[id];
        c.kalan--;
        let a = Math.abs(c.kalan), m = Math.floor(a/60), s = a%60;
        document.getElementById(`time-${id}`).innerText = (c.kalan<0?"-":"")+`${m}:${s < 10 ? '0' + s : s}`;
        if(c.kalan < 0) document.getElementById(`card-${id}`).classList.add('sure-doldu');
    }

    function masaKapat(id) {
        if(confirm("Masayƒ± sƒ±fƒ±rlamak istiyor musunuz?")) {
            clearInterval(cihazVerileri[id].interval);
            cihazVerileri[id] = null;
            cihazlariOlustur();
        }
    }

    const today = new Date().toISOString().split('T')[0];
    document.getElementById('rep-bas').value = today;
    document.getElementById('rep-bit').value = today;
    cihazlariOlustur();
</script>
</body>
</html>